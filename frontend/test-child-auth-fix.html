<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Child Authentication Fix Test</title>\n    <style>\n        body {\n            font-family: Arial, sans-serif;\n            max-width: 800px;\n            margin: 0 auto;\n            padding: 20px;\n            background-color: #f5f5f5;\n        }\n        .test-container {\n            background: white;\n            padding: 20px;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            margin-bottom: 20px;\n        }\n        .test-result {\n            padding: 10px;\n            margin: 10px 0;\n            border-radius: 4px;\n            font-weight: bold;\n        }\n        .success {\n            background-color: #d4edda;\n            color: #155724;\n            border: 1px solid #c3e6cb;\n        }\n        .error {\n            background-color: #f8d7da;\n            color: #721c24;\n            border: 1px solid #f5c6cb;\n        }\n        .info {\n            background-color: #d1ecf1;\n            color: #0c5460;\n            border: 1px solid #bee5eb;\n        }\n        button {\n            background-color: #007bff;\n            color: white;\n            border: none;\n            padding: 10px 20px;\n            border-radius: 4px;\n            cursor: pointer;\n            margin: 5px;\n        }\n        button:hover {\n            background-color: #0056b3;\n        }\n        button:disabled {\n            background-color: #6c757d;\n            cursor: not-allowed;\n        }\n        .log {\n            background-color: #f8f9fa;\n            border: 1px solid #dee2e6;\n            padding: 10px;\n            border-radius: 4px;\n            font-family: monospace;\n            font-size: 12px;\n            max-height: 300px;\n            overflow-y: auto;\n            white-space: pre-wrap;\n        }\n        .form-group {\n            margin-bottom: 15px;\n        }\n        label {\n            display: block;\n            margin-bottom: 5px;\n            font-weight: bold;\n        }\n        input {\n            width: 100%;\n            padding: 8px;\n            border: 1px solid #ddd;\n            border-radius: 4px;\n            box-sizing: border-box;\n        }\n    </style>\n</head>\n<body>\n    <h1>üîß Child Authentication Fix Test</h1>\n    <p>This page tests the enhanced child authentication system with proper session management and token refresh.</p>\n\n    <div class=\"test-container\">\n        <h2>üìã Test Configuration</h2>\n        <div class=\"form-group\">\n            <label for=\"apiUrl\">API Base URL:</label>\n            <input type=\"text\" id=\"apiUrl\" value=\"http://localhost:3001\" placeholder=\"http://localhost:3001\">\n        </div>\n        <div class=\"form-group\">\n            <label for=\"testUsername\">Test Username:</label>\n            <input type=\"text\" id=\"testUsername\" value=\"testchild\" placeholder=\"testchild\">\n        </div>\n        <div class=\"form-group\">\n            <label for=\"testPin\">Test PIN:</label>\n            <input type=\"text\" id=\"testPin\" value=\"1234\" placeholder=\"1234\">\n        </div>\n    </div>\n\n    <div class=\"test-container\">\n        <h2>üß™ Authentication Tests</h2>\n        <button onclick=\"testChildLogin()\">Test Child Login</button>\n        <button onclick=\"testTokenRefresh()\">Test Token Refresh</button>\n        <button onclick=\"testSessionPersistence()\">Test Session Persistence</button>\n        <button onclick=\"testLogout()\">Test Logout</button>\n        <button onclick=\"clearSession()\">Clear Session</button>\n        <button onclick=\"runAllTests()\">Run All Tests</button>\n        \n        <div id=\"testResults\"></div>\n    </div>\n\n    <div class=\"test-container\">\n        <h2>üìä Session Information</h2>\n        <button onclick=\"displaySessionInfo()\">Show Session Info</button>\n        <div id=\"sessionInfo\"></div>\n    </div>\n\n    <div class=\"test-container\">\n        <h2>üìù Test Log</h2>\n        <button onclick=\"clearLog()\">Clear Log</button>\n        <div id=\"testLog\" class=\"log\"></div>\n    </div>\n\n    <script>\n        let testLog = [];\n        let currentTokens = null;\n\n        function log(message, type = 'info') {\n            const timestamp = new Date().toLocaleTimeString();\n            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;\n            testLog.push(logEntry);\n            updateLogDisplay();\n            console.log(logEntry);\n        }\n\n        function updateLogDisplay() {\n            const logElement = document.getElementById('testLog');\n            logElement.textContent = testLog.join('\\n');\n            logElement.scrollTop = logElement.scrollHeight;\n        }\n\n        function clearLog() {\n            testLog = [];\n            updateLogDisplay();\n        }\n\n        function showResult(message, isSuccess) {\n            const resultsDiv = document.getElementById('testResults');\n            const resultDiv = document.createElement('div');\n            resultDiv.className = `test-result ${isSuccess ? 'success' : 'error'}`;\n            resultDiv.textContent = message;\n            resultsDiv.appendChild(resultDiv);\n        }\n\n        function clearResults() {\n            document.getElementById('testResults').innerHTML = '';\n        }\n\n        async function makeRequest(url, options = {}) {\n            const apiUrl = document.getElementById('apiUrl').value;\n            const fullUrl = `${apiUrl}${url}`;\n            \n            const defaultOptions = {\n                headers: {\n                    'Content-Type': 'application/json',\n                },\n                ...options\n            };\n\n            // Add auth token if available\n            const accessToken = localStorage.getItem('accessToken');\n            if (accessToken) {\n                defaultOptions.headers.Authorization = `Bearer ${accessToken}`;\n            }\n\n            log(`Making request to: ${fullUrl}`);\n            log(`Request options: ${JSON.stringify(defaultOptions, null, 2)}`);\n\n            try {\n                const response = await fetch(fullUrl, defaultOptions);\n                const responseText = await response.text();\n                \n                log(`Response status: ${response.status}`);\n                log(`Response headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`);\n                log(`Response body: ${responseText}`);\n\n                let responseData;\n                try {\n                    responseData = JSON.parse(responseText);\n                } catch (e) {\n                    responseData = { text: responseText };\n                }\n\n                if (!response.ok) {\n                    throw new Error(`HTTP ${response.status}: ${responseData.message || responseText}`);\n                }\n\n                return responseData;\n            } catch (error) {\n                log(`Request failed: ${error.message}`, 'error');\n                throw error;\n            }\n        }\n\n        async function testChildLogin() {\n            log('=== Testing Child Login ===');\n            clearResults();\n            \n            const username = document.getElementById('testUsername').value;\n            const pin = document.getElementById('testPin').value;\n\n            if (!username || !pin) {\n                showResult('Please enter username and PIN', false);\n                return;\n            }\n\n            try {\n                // Test legacy endpoint first\n                log('Attempting child login via legacy endpoint...');\n                const loginData = await makeRequest('/auth/child/login-legacy', {\n                    method: 'POST',\n                    body: JSON.stringify({ username, pin })\n                });\n\n                if (loginData.accessToken && loginData.refreshToken && loginData.user) {\n                    // Store tokens using SessionManager format\n                    const sessionData = {\n                        user: loginData.user,\n                        userRole: 'child',\n                        accessToken: loginData.accessToken,\n                        refreshToken: loginData.refreshToken,\n                        loginTime: new Date().toISOString(),\n                        sessionId: loginData.sessionId\n                    };\n\n                    // Store in localStorage\n                    localStorage.setItem('accessToken', loginData.accessToken);\n                    localStorage.setItem('refreshToken', loginData.refreshToken);\n                    localStorage.setItem('user', JSON.stringify(loginData.user));\n                    localStorage.setItem('userRole', 'child');\n                    localStorage.setItem('loginTime', sessionData.loginTime);\n                    if (loginData.sessionId) {\n                        localStorage.setItem('sessionId', loginData.sessionId);\n                    }\n\n                    currentTokens = {\n                        accessToken: loginData.accessToken,\n                        refreshToken: loginData.refreshToken\n                    };\n\n                    log('Child login successful!');\n                    log(`User ID: ${loginData.user.id}`);\n                    log(`Username: ${loginData.user.username}`);\n                    log(`Role: ${loginData.user.role}`);\n                    showResult('‚úÖ Child login successful!', true);\n                } else {\n                    throw new Error('Invalid response format - missing required fields');\n                }\n            } catch (error) {\n                log(`Child login failed: ${error.message}`, 'error');\n                showResult(`‚ùå Child login failed: ${error.message}`, false);\n            }\n        }\n\n        async function testTokenRefresh() {\n            log('=== Testing Token Refresh ===');\n            \n            const refreshToken = localStorage.getItem('refreshToken');\n            if (!refreshToken) {\n                showResult('‚ùå No refresh token found. Please login first.', false);\n                return;\n            }\n\n            try {\n                log('Attempting token refresh...');\n                const refreshData = await makeRequest('/auth/refresh', {\n                    method: 'POST',\n                    body: JSON.stringify({ refreshToken })\n                });\n\n                if (refreshData.accessToken && refreshData.refreshToken) {\n                    // Update stored tokens\n                    localStorage.setItem('accessToken', refreshData.accessToken);\n                    localStorage.setItem('refreshToken', refreshData.refreshToken);\n                    \n                    if (refreshData.user) {\n                        localStorage.setItem('user', JSON.stringify(refreshData.user));\n                    }\n\n                    currentTokens = {\n                        accessToken: refreshData.accessToken,\n                        refreshToken: refreshData.refreshToken\n                    };\n\n                    log('Token refresh successful!');\n                    showResult('‚úÖ Token refresh successful!', true);\n                } else {\n                    throw new Error('Invalid refresh response format');\n                }\n            } catch (error) {\n                log(`Token refresh failed: ${error.message}`, 'error');\n                showResult(`‚ùå Token refresh failed: ${error.message}`, false);\n            }\n        }\n\n        async function testSessionPersistence() {\n            log('=== Testing Session Persistence ===');\n            \n            const accessToken = localStorage.getItem('accessToken');\n            if (!accessToken) {\n                showResult('‚ùå No access token found. Please login first.', false);\n                return;\n            }\n\n            try {\n                log('Testing protected endpoint access...');\n                const profileData = await makeRequest('/child/profile');\n                \n                log('Protected endpoint access successful!');\n                log(`Profile data: ${JSON.stringify(profileData, null, 2)}`);\n                showResult('‚úÖ Session persistence working!', true);\n            } catch (error) {\n                log(`Session persistence test failed: ${error.message}`, 'error');\n                showResult(`‚ùå Session persistence failed: ${error.message}`, false);\n            }\n        }\n\n        async function testLogout() {\n            log('=== Testing Logout ===');\n            \n            const accessToken = localStorage.getItem('accessToken');\n            if (!accessToken) {\n                showResult('‚ùå No access token found. Already logged out.', false);\n                return;\n            }\n\n            try {\n                log('Attempting logout...');\n                await makeRequest('/auth/logout', {\n                    method: 'POST'\n                });\n                \n                log('Logout successful!');\n                showResult('‚úÖ Logout successful!', true);\n            } catch (error) {\n                log(`Logout failed: ${error.message}`, 'error');\n                showResult(`‚ùå Logout failed: ${error.message}`, false);\n            } finally {\n                // Clear local session regardless of logout API result\n                clearSession();\n            }\n        }\n\n        function clearSession() {\n            log('=== Clearing Local Session ===');\n            \n            const keysToRemove = [\n                'accessToken',\n                'refreshToken', \n                'user',\n                'userRole',\n                'loginTime',\n                'sessionId'\n            ];\n            \n            keysToRemove.forEach(key => {\n                localStorage.removeItem(key);\n                log(`Removed: ${key}`);\n            });\n            \n            currentTokens = null;\n            showResult('‚úÖ Session cleared!', true);\n        }\n\n        function displaySessionInfo() {\n            log('=== Displaying Session Information ===');\n            \n            const sessionInfo = {\n                accessToken: localStorage.getItem('accessToken'),\n                refreshToken: localStorage.getItem('refreshToken'),\n                user: localStorage.getItem('user'),\n                userRole: localStorage.getItem('userRole'),\n                loginTime: localStorage.getItem('loginTime'),\n                sessionId: localStorage.getItem('sessionId')\n            };\n\n            const sessionInfoDiv = document.getElementById('sessionInfo');\n            sessionInfoDiv.innerHTML = `\n                <div class=\"info\">\n                    <h4>Current Session Data:</h4>\n                    <pre>${JSON.stringify(sessionInfo, null, 2)}</pre>\n                </div>\n            `;\n\n            log('Session info displayed');\n        }\n\n        async function runAllTests() {\n            log('=== Running All Tests ===');\n            clearResults();\n            \n            // Clear session first\n            clearSession();\n            \n            // Wait a bit between tests\n            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));\n            \n            try {\n                await testChildLogin();\n                await delay(1000);\n                \n                await testSessionPersistence();\n                await delay(1000);\n                \n                await testTokenRefresh();\n                await delay(1000);\n                \n                await testSessionPersistence();\n                await delay(1000);\n                \n                await testLogout();\n                \n                log('=== All Tests Completed ===');\n                showResult('üéâ All tests completed! Check individual results above.', true);\n            } catch (error) {\n                log(`Test suite failed: ${error.message}`, 'error');\n                showResult(`‚ùå Test suite failed: ${error.message}`, false);\n            }\n        }\n\n        // Initialize\n        log('Child Authentication Fix Test Page Loaded');\n        displaySessionInfo();\n    </script>\n</body>\n</html>"