<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>API Interceptor Enhancement Test</title>\n    <style>\n        body {\n            font-family: Arial, sans-serif;\n            max-width: 1000px;\n            margin: 0 auto;\n            padding: 20px;\n            background-color: #f5f5f5;\n        }\n        .test-container {\n            background: white;\n            padding: 20px;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            margin-bottom: 20px;\n        }\n        .test-result {\n            padding: 10px;\n            margin: 10px 0;\n            border-radius: 4px;\n            font-weight: bold;\n        }\n        .success {\n            background-color: #d4edda;\n            color: #155724;\n            border: 1px solid #c3e6cb;\n        }\n        .error {\n            background-color: #f8d7da;\n            color: #721c24;\n            border: 1px solid #f5c6cb;\n        }\n        .info {\n            background-color: #d1ecf1;\n            color: #0c5460;\n            border: 1px solid #bee5eb;\n        }\n        .warning {\n            background-color: #fff3cd;\n            color: #856404;\n            border: 1px solid #ffeaa7;\n        }\n        button {\n            background-color: #007bff;\n            color: white;\n            border: none;\n            padding: 10px 20px;\n            border-radius: 4px;\n            cursor: pointer;\n            margin: 5px;\n        }\n        button:hover {\n            background-color: #0056b3;\n        }\n        button:disabled {\n            background-color: #6c757d;\n            cursor: not-allowed;\n        }\n        .log {\n            background-color: #f8f9fa;\n            border: 1px solid #dee2e6;\n            padding: 10px;\n            border-radius: 4px;\n            font-family: monospace;\n            font-size: 12px;\n            max-height: 400px;\n            overflow-y: auto;\n            white-space: pre-wrap;\n        }\n        .form-group {\n            margin-bottom: 15px;\n        }\n        label {\n            display: block;\n            margin-bottom: 5px;\n            font-weight: bold;\n        }\n        input, select {\n            width: 100%;\n            padding: 8px;\n            border: 1px solid #ddd;\n            border-radius: 4px;\n            box-sizing: border-box;\n        }\n        .grid {\n            display: grid;\n            grid-template-columns: 1fr 1fr;\n            gap: 20px;\n        }\n        .status-indicator {\n            display: inline-block;\n            width: 12px;\n            height: 12px;\n            border-radius: 50%;\n            margin-right: 8px;\n        }\n        .status-active { background-color: #28a745; }\n        .status-inactive { background-color: #dc3545; }\n        .status-pending { background-color: #ffc107; }\n    </style>\n</head>\n<body>\n    <h1>üîß API Interceptor Enhancement Test</h1>\n    <p>This page tests the enhanced API token refresh interceptor with role-based redirect logic and queue management.</p>\n\n    <div class=\"test-container\">\n        <h2>üìã Test Configuration</h2>\n        <div class=\"grid\">\n            <div>\n                <div class=\"form-group\">\n                    <label for=\"apiUrl\">API Base URL:</label>\n                    <input type=\"text\" id=\"apiUrl\" value=\"http://localhost:3001\" placeholder=\"http://localhost:3001\">\n                </div>\n                <div class=\"form-group\">\n                    <label for=\"testUsername\">Test Username:</label>\n                    <input type=\"text\" id=\"testUsername\" value=\"testchild\" placeholder=\"testchild\">\n                </div>\n                <div class=\"form-group\">\n                    <label for=\"testPin\">Test PIN:</label>\n                    <input type=\"text\" id=\"testPin\" value=\"1234\" placeholder=\"1234\">\n                </div>\n            </div>\n            <div>\n                <div class=\"form-group\">\n                    <label for=\"userType\">User Type:</label>\n                    <select id=\"userType\">\n                        <option value=\"child\">Child User</option>\n                        <option value=\"parent\">Parent User</option>\n                    </select>\n                </div>\n                <div class=\"form-group\">\n                    <label for=\"parentEmail\">Parent Email:</label>\n                    <input type=\"email\" id=\"parentEmail\" value=\"testparent@example.com\" placeholder=\"testparent@example.com\">\n                </div>\n                <div class=\"form-group\">\n                    <label for=\"parentPassword\">Parent Password:</label>\n                    <input type=\"password\" id=\"parentPassword\" value=\"testpassword123\" placeholder=\"testpassword123\">\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <div class=\"test-container\">\n        <h2>üß™ API Interceptor Tests</h2>\n        <button onclick=\"testLogin()\">Test Login</button>\n        <button onclick=\"testTokenRefresh()\">Test Token Refresh</button>\n        <button onclick=\"testConcurrentRequests()\">Test Concurrent Requests</button>\n        <button onclick=\"testExpiredToken()\">Test Expired Token</button>\n        <button onclick=\"testRoleBasedRedirect()\">Test Role-Based Redirect</button>\n        <button onclick=\"testQueueManagement()\">Test Queue Management</button>\n        <button onclick=\"clearSession()\">Clear Session</button>\n        <button onclick=\"runAllTests()\">Run All Tests</button>\n        \n        <div id=\"testResults\"></div>\n    </div>\n\n    <div class=\"test-container\">\n        <h2>üìä Session Status</h2>\n        <button onclick=\"displaySessionStatus()\">Refresh Status</button>\n        <div id=\"sessionStatus\"></div>\n    </div>\n\n    <div class=\"test-container\">\n        <h2>üìù Test Log</h2>\n        <button onclick=\"clearLog()\">Clear Log</button>\n        <div id=\"testLog\" class=\"log\"></div>\n    </div>\n\n    <script>\n        let testLog = [];\n        let currentTokens = null;\n        let testResults = [];\n\n        // Enhanced API client with interceptor\n        class EnhancedApiClient {\n            constructor(baseURL) {\n                this.baseURL = baseURL;\n                this.isRefreshing = false;\n                this.failedQueue = [];\n            }\n\n            processQueue(error, token = null) {\n                this.failedQueue.forEach(({ resolve, reject }) => {\n                    if (error) {\n                        reject(error);\n                    } else {\n                        resolve(token);\n                    }\n                });\n                this.failedQueue = [];\n            }\n\n            async makeRequest(endpoint, options = {}) {\n                const url = `${this.baseURL}${endpoint}`;\n                \n                const config = {\n                    method: 'GET',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    ...options\n                };\n\n                // Add auth token if available\n                const accessToken = localStorage.getItem('accessToken');\n                if (accessToken) {\n                    config.headers.Authorization = `Bearer ${accessToken}`;\n                }\n\n                log(`Making request: ${config.method} ${url}`);\n                \n                try {\n                    const response = await fetch(url, config);\n                    \n                    // Handle 401 with token refresh\n                    if (response.status === 401 && !options._retry) {\n                        log('401 detected, attempting token refresh');\n                        \n                        if (this.isRefreshing) {\n                            // Queue this request\n                            return new Promise((resolve, reject) => {\n                                this.failedQueue.push({ resolve, reject });\n                            }).then(token => {\n                                if (token) {\n                                    config.headers.Authorization = `Bearer ${token}`;\n                                }\n                                return this.makeRequest(endpoint, { ...options, _retry: true });\n                            });\n                        }\n\n                        this.isRefreshing = true;\n                        \n                        try {\n                            const refreshToken = localStorage.getItem('refreshToken');\n                            const currentUserRole = localStorage.getItem('userRole');\n                            \n                            if (!refreshToken) {\n                                throw new Error('No refresh token available');\n                            }\n\n                            log(`Refreshing tokens for ${currentUserRole} user`);\n                            \n                            const refreshResponse = await fetch(`${this.baseURL}/auth/refresh`, {\n                                method: 'POST',\n                                headers: {\n                                    'Content-Type': 'application/json',\n                                },\n                                body: JSON.stringify({ refreshToken })\n                            });\n\n                            if (!refreshResponse.ok) {\n                                throw new Error(`Refresh failed: ${refreshResponse.status}`);\n                            }\n\n                            const refreshData = await refreshResponse.json();\n                            const { accessToken: newAccessToken, refreshToken: newRefreshToken, user } = refreshData;\n                            \n                            // Update tokens\n                            localStorage.setItem('accessToken', newAccessToken);\n                            localStorage.setItem('refreshToken', newRefreshToken);\n                            \n                            if (user) {\n                                localStorage.setItem('user', JSON.stringify(user));\n                                const newUserRole = user.role === 'CHILD' ? 'child' : 'parent';\n                                localStorage.setItem('userRole', newUserRole);\n                            }\n                            \n                            // Process queued requests\n                            this.processQueue(null, newAccessToken);\n                            \n                            log('Token refresh successful');\n                            \n                            // Retry original request\n                            config.headers.Authorization = `Bearer ${newAccessToken}`;\n                            return this.makeRequest(endpoint, { ...options, _retry: true });\n                        } catch (refreshError) {\n                            log(`Token refresh failed: ${refreshError.message}`, 'error');\n                            \n                            // Process queued requests with error\n                            this.processQueue(refreshError, null);\n                            \n                            // Clear session and handle redirect\n                            const currentUserRole = localStorage.getItem('userRole');\n                            this.clearSession();\n                            \n                            // Role-based redirect logic would go here\n                            log(`Would redirect ${currentUserRole} user to appropriate login page`, 'warning');\n                            \n                            throw refreshError;\n                        } finally {\n                            this.isRefreshing = false;\n                        }\n                    }\n\n                    const responseText = await response.text();\n                    log(`Response: ${response.status} ${response.statusText}`);\n                    log(`Response body: ${responseText}`);\n\n                    let responseData;\n                    try {\n                        responseData = JSON.parse(responseText);\n                    } catch (e) {\n                        responseData = { text: responseText };\n                    }\n\n                    if (!response.ok) {\n                        throw new Error(`HTTP ${response.status}: ${responseData.message || responseText}`);\n                    }\n\n                    return responseData;\n                } catch (error) {\n                    log(`Request failed: ${error.message}`, 'error');\n                    throw error;\n                }\n            }\n\n            clearSession() {\n                const keysToRemove = [\n                    'accessToken',\n                    'refreshToken', \n                    'user',\n                    'userRole',\n                    'loginTime',\n                    'sessionId'\n                ];\n                \n                keysToRemove.forEach(key => {\n                    localStorage.removeItem(key);\n                });\n                \n                log('Session cleared');\n            }\n        }\n\n        const apiClient = new EnhancedApiClient(document.getElementById('apiUrl').value);\n\n        function log(message, type = 'info') {\n            const timestamp = new Date().toLocaleTimeString();\n            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;\n            testLog.push(logEntry);\n            updateLogDisplay();\n            console.log(logEntry);\n        }\n\n        function updateLogDisplay() {\n            const logElement = document.getElementById('testLog');\n            logElement.textContent = testLog.join('\\n');\n            logElement.scrollTop = logElement.scrollHeight;\n        }\n\n        function clearLog() {\n            testLog = [];\n            updateLogDisplay();\n        }\n\n        function showResult(message, isSuccess, type = 'test') {\n            const resultsDiv = document.getElementById('testResults');\n            const resultDiv = document.createElement('div');\n            resultDiv.className = `test-result ${isSuccess ? 'success' : 'error'}`;\n            resultDiv.innerHTML = `\n                <span class=\"status-indicator ${isSuccess ? 'status-active' : 'status-inactive'}\"></span>\n                ${message}\n            `;\n            resultsDiv.appendChild(resultDiv);\n            \n            testResults.push({ message, isSuccess, type, timestamp: new Date().toISOString() });\n        }\n\n        function clearResults() {\n            document.getElementById('testResults').innerHTML = '';\n            testResults = [];\n        }\n\n        async function testLogin() {\n            log('=== Testing Login ===');\n            \n            const userType = document.getElementById('userType').value;\n            \n            try {\n                let loginData;\n                \n                if (userType === 'child') {\n                    const username = document.getElementById('testUsername').value;\n                    const pin = document.getElementById('testPin').value;\n                    \n                    loginData = await apiClient.makeRequest('/auth/child/login-legacy', {\n                        method: 'POST',\n                        body: JSON.stringify({ username, pin })\n                    });\n                } else {\n                    const email = document.getElementById('parentEmail').value;\n                    const password = document.getElementById('parentPassword').value;\n                    \n                    loginData = await apiClient.makeRequest('/auth/login', {\n                        method: 'POST',\n                        body: JSON.stringify({ email, password })\n                    });\n                }\n\n                // Store session data\n                localStorage.setItem('accessToken', loginData.accessToken);\n                localStorage.setItem('refreshToken', loginData.refreshToken);\n                localStorage.setItem('user', JSON.stringify(loginData.user));\n                localStorage.setItem('userRole', userType);\n                localStorage.setItem('loginTime', new Date().toISOString());\n                \n                if (loginData.sessionId) {\n                    localStorage.setItem('sessionId', loginData.sessionId);\n                }\n\n                currentTokens = {\n                    accessToken: loginData.accessToken,\n                    refreshToken: loginData.refreshToken\n                };\n\n                showResult(`‚úÖ ${userType} login successful`, true);\n                displaySessionStatus();\n            } catch (error) {\n                showResult(`‚ùå ${userType} login failed: ${error.message}`, false);\n            }\n        }\n\n        async function testTokenRefresh() {\n            log('=== Testing Token Refresh ===');\n            \n            if (!currentTokens?.refreshToken) {\n                showResult('‚ùå No refresh token available. Please login first.', false);\n                return;\n            }\n\n            try {\n                const refreshData = await apiClient.makeRequest('/auth/refresh', {\n                    method: 'POST',\n                    body: JSON.stringify({ refreshToken: currentTokens.refreshToken })\n                });\n\n                // Update stored tokens\n                localStorage.setItem('accessToken', refreshData.accessToken);\n                localStorage.setItem('refreshToken', refreshData.refreshToken);\n                \n                if (refreshData.user) {\n                    localStorage.setItem('user', JSON.stringify(refreshData.user));\n                }\n\n                currentTokens = {\n                    accessToken: refreshData.accessToken,\n                    refreshToken: refreshData.refreshToken\n                };\n\n                showResult('‚úÖ Token refresh successful', true);\n                displaySessionStatus();\n            } catch (error) {\n                showResult(`‚ùå Token refresh failed: ${error.message}`, false);\n            }\n        }\n\n        async function testConcurrentRequests() {\n            log('=== Testing Concurrent Requests ===');\n            \n            if (!currentTokens?.accessToken) {\n                showResult('‚ùå No access token available. Please login first.', false);\n                return;\n            }\n\n            try {\n                // Make multiple concurrent requests that might trigger token refresh\n                const requests = [];\n                for (let i = 0; i < 5; i++) {\n                    requests.push(apiClient.makeRequest('/child/profile'));\n                }\n                \n                const results = await Promise.all(requests);\n                \n                showResult(`‚úÖ Concurrent requests successful (${results.length} requests)`, true);\n            } catch (error) {\n                showResult(`‚ùå Concurrent requests failed: ${error.message}`, false);\n            }\n        }\n\n        async function testExpiredToken() {\n            log('=== Testing Expired Token Handling ===');\n            \n            // Set a fake expired token\n            localStorage.setItem('accessToken', 'expired_token_12345');\n            \n            try {\n                await apiClient.makeRequest('/child/profile');\n                showResult('‚ùå Expired token was accepted (security issue)', false);\n            } catch (error) {\n                if (error.message.includes('401') || error.message.includes('refresh')) {\n                    showResult('‚úÖ Expired token properly handled', true);\n                } else {\n                    showResult(`‚ùå Unexpected error: ${error.message}`, false);\n                }\n            }\n        }\n\n        async function testRoleBasedRedirect() {\n            log('=== Testing Role-Based Redirect Logic ===');\n            \n            // This test simulates the redirect logic without actually redirecting\n            const testCases = [\n                { userRole: 'child', expectedRedirect: '/child-login' },\n                { userRole: 'parent', expectedRedirect: '/login' },\n                { userRole: null, expectedRedirect: '/login' }\n            ];\n\n            let allPassed = true;\n            \n            for (const testCase of testCases) {\n                localStorage.setItem('userRole', testCase.userRole || '');\n                \n                // Simulate token refresh failure\n                try {\n                    await apiClient.makeRequest('/auth/refresh', {\n                        method: 'POST',\n                        body: JSON.stringify({ refreshToken: 'invalid_token' })\n                    });\n                } catch (error) {\n                    // Expected to fail\n                }\n                \n                // Check if the correct redirect logic would be applied\n                const currentUserRole = localStorage.getItem('userRole');\n                const expectedRedirect = testCase.expectedRedirect;\n                \n                log(`Role: ${testCase.userRole} -> Expected redirect: ${expectedRedirect}`);\n            }\n            \n            showResult('‚úÖ Role-based redirect logic tested', allPassed);\n        }\n\n        async function testQueueManagement() {\n            log('=== Testing Queue Management ===');\n            \n            if (!currentTokens?.refreshToken) {\n                showResult('‚ùå No refresh token available. Please login first.', false);\n                return;\n            }\n\n            try {\n                // Simulate multiple requests that would trigger refresh\n                localStorage.setItem('accessToken', 'expired_token');\n                \n                const requests = [];\n                for (let i = 0; i < 3; i++) {\n                    requests.push(apiClient.makeRequest('/child/profile'));\n                }\n                \n                const results = await Promise.allSettled(requests);\n                const successCount = results.filter(r => r.status === 'fulfilled').length;\n                \n                showResult(`‚úÖ Queue management test completed (${successCount}/${results.length} succeeded)`, successCount > 0);\n            } catch (error) {\n                showResult(`‚ùå Queue management test failed: ${error.message}`, false);\n            }\n        }\n\n        function clearSession() {\n            apiClient.clearSession();\n            currentTokens = null;\n            showResult('‚úÖ Session cleared', true);\n            displaySessionStatus();\n        }\n\n        function displaySessionStatus() {\n            const sessionInfo = {\n                accessToken: localStorage.getItem('accessToken'),\n                refreshToken: localStorage.getItem('refreshToken'),\n                user: localStorage.getItem('user'),\n                userRole: localStorage.getItem('userRole'),\n                loginTime: localStorage.getItem('loginTime'),\n                sessionId: localStorage.getItem('sessionId')\n            };\n\n            const sessionStatusDiv = document.getElementById('sessionStatus');\n            const hasSession = !!(sessionInfo.accessToken && sessionInfo.refreshToken);\n            \n            sessionStatusDiv.innerHTML = `\n                <div class=\"info\">\n                    <h4>\n                        <span class=\"status-indicator ${hasSession ? 'status-active' : 'status-inactive'}\"></span>\n                        Session Status: ${hasSession ? 'Active' : 'Inactive'}\n                    </h4>\n                    <pre>${JSON.stringify(sessionInfo, null, 2)}</pre>\n                </div>\n            `;\n        }\n\n        async function runAllTests() {\n            log('=== Running All API Interceptor Tests ===');\n            clearResults();\n            \n            try {\n                await testLogin();\n                await new Promise(resolve => setTimeout(resolve, 1000));\n                \n                await testTokenRefresh();\n                await new Promise(resolve => setTimeout(resolve, 1000));\n                \n                await testConcurrentRequests();\n                await new Promise(resolve => setTimeout(resolve, 1000));\n                \n                await testExpiredToken();\n                await new Promise(resolve => setTimeout(resolve, 1000));\n                \n                await testRoleBasedRedirect();\n                await new Promise(resolve => setTimeout(resolve, 1000));\n                \n                await testQueueManagement();\n                \n                log('=== All Tests Completed ===');\n                \n                const totalTests = testResults.length;\n                const passedTests = testResults.filter(r => r.isSuccess).length;\n                \n                showResult(`üéâ Test Suite Complete: ${passedTests}/${totalTests} tests passed`, passedTests === totalTests);\n            } catch (error) {\n                log(`Test suite failed: ${error.message}`, 'error');\n                showResult(`‚ùå Test suite failed: ${error.message}`, false);\n            }\n        }\n\n        // Initialize\n        log('API Interceptor Enhancement Test Page Loaded');\n        displaySessionStatus();\n        \n        // Update API client when URL changes\n        document.getElementById('apiUrl').addEventListener('change', (e) => {\n            apiClient.baseURL = e.target.value;\n            log(`API URL updated to: ${e.target.value}`);\n        });\n    </script>\n</body>\n</html>"